// Environment parameterize
// Set ${REGISTRY_REPO_URL}, ${REPO_NAME}, skaffold images ${SKAFFOLD_IMAGE}
// username and password: registry_id from Jenkins UI.

def scmVars // please refer this instance if you need scm information.

podTemplate(
  label: 'skaffold',
  cloud: 'kubernetes',
  containers: [
    containerTemplate(name: 'skaffold-insider', image: 'makotow/skaffold-docker:1.0-v0.34.0', ttyEnabled: true, command: 'cat', alwaysPullImage: false)
  ],
  volumes: [
    hostPathVolume(hostPath: '/var/run/docker.sock', mountPath: '/var/run/docker.sock')
  ]
) {
  node('skaffold') {
    withCredentials([
      usernamePassword(credentialsId: 'registry_id', usernameVariable: 'REGISTRY_ID_USER', passwordVariable: 'REGISTRY_ID_PASSWORD')
    ]) {
    parameters {
        string(name: 'REGISTRY_REPO_URL', defaultValue: 'gcr.io/hm-hands-on', description: 'イメージレジストリ')
        string(name: 'REPO_NAME', defaultValue: 'user99', description: 'レジストリ名')
        string(name: 'NAMESPACE', defaultValue: 'msa-demo', description: 'デプロイ先のネームスペース')
    }

      stage('Info') {
        container('skaffold-insider') {
          sh """
            uname -a
            whoami
            pwd
            ls -al
          """
        }
      }
      
      stage('Clone source code') {
        scmVars = checkout scm
      }

      stage('Run skaffold') {
        container('skaffold-insider') {
          sh """
            docker login https://${REGISTRY_REPO_URL} -u '${REGISTRY_ID_USER}' -p '${REGISTRY_ID_PASSWORD}'
            skaffold run -d ${REGISTRY_REPO_URL}/${REPO_NAME} -n ${NAMESPACE}
          """
        }
      }
    }
  }
}
